name: Terraform Deploy

on:
  push:
    branches: [ main ]
    paths:
      - '**.tf'
      - '**.tfvars'
      - '.github/workflows/terraform-*.yml'
  workflow_dispatch:  # Allow manual triggers

permissions:
  id-token: write   # Required for OIDC token
  contents: read    # Required to checkout code

jobs:
  terraform-deploy:
    name: Terraform Deploy
    runs-on: ubuntu-latest
    environment: tf-apply-dev  # Use environment protection rules
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0
    
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        role-session-name: terraform-deploy-session
        aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}
    
    - name: Get Vault Token via OIDC
      id: vault-auth
      run: |
        # Get GitHub OIDC token
        GITHUB_TOKEN=$(curl -H "Authorization: bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" \
          "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=https://github.com/${{ github.repository_owner }}" | jq -r .value)
        
        # Exchange for Vault token using apply role
        VAULT_TOKEN=$(curl -s -X POST \
          -H "Content-Type: application/json" \
          -d "{\"jwt\":\"${GITHUB_TOKEN}\",\"role\":\"tf-github-actions-role-apply\"}" \
          "${{ vars.VAULT_ADDR }}/v1/auth/jwt/login" | jq -r .auth.client_token)
        
        echo "vault-token=${VAULT_TOKEN}" >> $GITHUB_OUTPUT
        echo "::add-mask::${VAULT_TOKEN}"
    
    - name: Terraform Init
      run: terraform init
      env:
        VAULT_TOKEN: ${{ steps.vault-auth.outputs.vault-token }}
        VAULT_ADDR: ${{ vars.VAULT_ADDR }}
        VAULT_SKIP_VERIFY: "true"  # For dev environment with self-signed certs
    
    - name: Terraform Plan
      id: plan
      run: |
        echo "## ðŸ“‹ Terraform Plan" >> $GITHUB_STEP_SUMMARY
        terraform plan -no-color -out=tfplan
        terraform show -no-color tfplan > plan-output.txt
        
        # Add plan summary to job summary
        echo '<details><summary>ðŸ“– View Terraform Plan</summary>' >> $GITHUB_STEP_SUMMARY
        echo '' >> $GITHUB_STEP_SUMMARY
        echo '```hcl' >> $GITHUB_STEP_SUMMARY
        head -50 plan-output.txt >> $GITHUB_STEP_SUMMARY
        if [ $(wc -l < plan-output.txt) -gt 50 ]; then
          echo '...' >> $GITHUB_STEP_SUMMARY
          echo '(Plan truncated - see full output in logs)' >> $GITHUB_STEP_SUMMARY
        fi
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo '</details>' >> $GITHUB_STEP_SUMMARY
      env:
        VAULT_TOKEN: ${{ steps.vault-auth.outputs.vault-token }}
        VAULT_ADDR: ${{ vars.VAULT_ADDR }}
        VAULT_SKIP_VERIFY: "true"
        TF_VAR_vault_domain: ${{ vars.VAULT_DOMAIN }}
        TF_VAR_route53_zone_id: ${{ secrets.ROUTE53_ZONE_ID }}
        TF_VAR_my_ip: ${{ secrets.MY_IP }}
    
    - name: Terraform Apply
      id: apply
      run: |
        echo "## ðŸš€ Terraform Apply" >> $GITHUB_STEP_SUMMARY
        echo "Applying Terraform changes..." >> $GITHUB_STEP_SUMMARY
        
        terraform apply -auto-approve tfplan
        
        if [ $? -eq 0 ]; then
          echo "âœ… **Apply Status**: SUCCESS" >> $GITHUB_STEP_SUMMARY
          echo "Infrastructure has been successfully updated!" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Apply Status**: FAILED" >> $GITHUB_STEP_SUMMARY
          echo "Infrastructure deployment failed. Check logs for details." >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
      env:
        VAULT_TOKEN: ${{ steps.vault-auth.outputs.vault-token }}
        VAULT_ADDR: ${{ vars.VAULT_ADDR }}
        VAULT_SKIP_VERIFY: "true"
        TF_VAR_vault_domain: ${{ vars.VAULT_DOMAIN }}
        TF_VAR_route53_zone_id: ${{ secrets.ROUTE53_ZONE_ID }}
        TF_VAR_my_ip: ${{ secrets.MY_IP }}
    
    - name: Output Important Information
      run: |
        echo "## ðŸ“Š Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Show Terraform outputs if any
        if terraform output > /dev/null 2>&1; then
          echo "### ðŸ”§ Terraform Outputs" >> $GITHUB_STEP_SUMMARY
          terraform output >> $GITHUB_STEP_SUMMARY
        fi
      env:
        VAULT_TOKEN: ${{ steps.vault-auth.outputs.vault-token }}
        VAULT_ADDR: ${{ vars.VAULT_ADDR }}
        VAULT_SKIP_VERIFY: "true"
    
    - name: Cleanup
      if: always()
      run: |
        # Clean up sensitive files
        rm -f tfplan plan-output.txt
        
        # Revoke Vault token if possible
        if [ -n "${{ steps.vault-auth.outputs.vault-token }}" ]; then
          curl -s -X POST \
            -H "X-Vault-Token: ${{ steps.vault-auth.outputs.vault-token }}" \
            "${{ vars.VAULT_ADDR }}/v1/auth/token/revoke-self" || true
        fi